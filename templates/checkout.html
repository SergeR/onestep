<div class="checkout-header">
    <div class="float-right large">
        {$cart_total = $wa->shop->cart->total()}
        [`Order total`]: <strong>{shop_currency_html($cart_total, true)}</strong>
    </div>
    <h3><a href="{$wa_app_url}">{$wa->shop->settings("name")}</a></h3>
</div>

<div class="checkout">

    {if isset($checkout_steps)}

        {foreach $checkout_steps as $step_id => $s}
            <form class="checkout-form" method="post" action="">
                <div class="checkout-step step-{$step_id}" data-step="{$step_id}">

                    <h2 class="{if isset($_upcoming_flag)}upcoming{/if}">
                        <span class="gray">{$s@iteration}.</span> {$s.name}<span class="loading"></span>
                    </h2>

                    {if $s@first}
                        <div class="checkout-step-content auth" >
                            {if !$wa->user()->isAuth()}
                                <!-- authorized / not authorized selector -->
                                <ul class="menu-v">
                                    <li><label><input name="user_type" type="radio" {if !$wa->post('wa_auth_login')}checked{/if} value="0"> [`Iâ€™m a new customer`]</label></li>
                                    <li><label><input name="user_type" type="radio" {if $wa->post('wa_auth_login')}checked{/if} value="1"> [`I already have an account`]</label></li>
                                </ul>
                                <div id="login-form"{if !$wa->post('wa_auth_login')} style="display:none"{/if}>
                                    {include file="login.html" without_form=true}
                                </div>
                                <div class="clear-both"></div>
                            {else}
                                <!-- authorized -->
                                <blockquote>
                                    <img src="{$wa->user()->getPhoto(50)}">
                                    <p>
                                        <span class="black">{sprintf("[`You are currently authorized as <strong>%s</strong>. Please verify or update your contact information using the form below. Your existing contact info will be automatically updated.`]", $wa->user('name'))}</span>
                                        <br>
                                        <em>[`If you want to place an order on behalf of another customer, <a href="?logout">log out</a> from your current profile and proceed to checkout again.`]</em>
                                    </p>
                                </blockquote>
                                <div class="clear-both"></div>
                            {/if}
                        </div>
                    {/if}

                    <div class="checkout-step-content" style="{if $wa->post('wa_auth_login')} display:none;{/if}">

                        {if in_array($step_id,['contactinfo', 'shipping', 'payment', 'confirmation'])}
                            {include file="checkout.`$step_id`.html"}
                        {/if}

                        <div class="clear-both"></div>

                        {if $s@last}
                            {if empty($error)}
                                <div class="float-right">
                                    <input name="confirmation" type="hidden" value="1" >
                                    <input type="submit" class=" large bold" value="[`Place order`]">
                                </div>
                            {/if}
                        {/if}
                        <div class="clear-both"></div>
                    </div>

                </div>
            </form>
        {/foreach}

    {/if}

</div>

<script type="text/javascript">
    $(function() {

        function auth() {
            $("#login-form input").attr('disabled', 'disabled');
            $("input[name='user_type']").change(function() {
                if ($("input[name='user_type']:checked").val() == '1') {
                    $("#login-form input").removeAttr('disabled');
                    $(this).closest('div.auth').next(".checkout-step-content").hide();
                    $("input[type=submit]:last").hide();
                    $("#login-form").show();
                } else {
                    $("#login-form input").attr('disabled', 'disabled');
                    $("#login-form").hide();
                    $(this).closest('div.auth').next(".checkout-step-content").show();
                    $("input[type=submit]:last").show();
                }
            });
            $("input[name='user_type']").change();
        }

        auth();

        var steps = ['{implode("','", array_keys($checkout_steps))}'];

        $("form.checkout-form").on('change', 'input:not([name="user_type"]),select', function() {
            var f = $(this).closest('form.checkout-form');
            var cur_step = f.find('.checkout-step').data('step');

            var j = steps.indexOf(cur_step);
            for (var i in steps) {
                if (i > j) {
                    $('.step-' + steps[i] + ' h2 span.loading').html('<i class="icon16 loading"></i>');
                    $('.step-' + steps[i]).find('input, select').attr('disabled', 'disabled');
                }
            }

            $.post(f.attr('action') || window.location, f.serialize(), function(response) {
                var j = steps.indexOf(cur_step);
                for (var i in steps) {
                    if (i > j) {
                        var step = steps[i];
                        var html = $(response).find('.step-' + step).html();
                        $('.step-' + step).html(html);
                    }
                }

            });
        });

        $("form.checkout-form").on('submit', function() {
            var f = $(this);
            if (f.hasClass('last') || ($("#login-form").length && !$("#login-form input:submit").attr('disabled'))) {
                return true;
            }

            if (!$("form.checkout-form").find('input[name="shipping_id"]:checked').not(':disabled').length) {
                if (!f.find('em.errormsg').length) {
                    $('<em class="errormsg inline">' + ('[`Please select shipping option`]') + '</em>').insertBefore(f.find('input:submit:last'));
                }
                return false;
            } else if (!$("form.checkout-form").find('input[name="payment_id"]:checked').not(':disabled').length) {
                if (!f.find('em.errormsg').length) {
                    $('<em class="errormsg inline">' + ('[`Please select payment option`]') + '</em>').insertBefore(f.find('input:submit:last'));
                }
                return false;
            } else {
                f.find('em.errormsg').remove();
            }


            $('<span class="loading"> <i class="icon16 loading"></i></span>').insertAfter(f.find('input:submit:last').attr('disabled', 'disabled'));
            $.post(f.attr('action') || window.location, $("form.checkout-form").serialize(), function(response) {
                console.log(response);
                //if (response.redirect) {
                //    window.location.href = response.redirect;
                //}
                /*
                 for (var i in steps) {
                 var step = steps[i];
                 var html = $(response).find('.step-' + step).html();
                 $('.step-' + step).html(html);
                 }
                 
                 if ($("form.checkout-form").find('.error:first').length) {
                 var destination = $("form.checkout-form").find('.error:first').offset().top;
                 jQuery("html,body").animate({
                 scrollTop: destination
                 });
                 }
                 
                 auth();
                 */
            }, "json");
            return false;

        });
        /*
         $("form.checkout-form").on('submit', function() {
         var f = $(this);
         var step = f.find('.checkout-content').data('step-id');
         if (step == 'payment' || step == 'shipping') {
         if (!f.find('input[name="' + step + '_id"]:checked').not(':disabled').length) {
         if (!f.find('em.errormsg').length) {
         $('<em class="errormsg inline">' + (step == 'payment' ? '[`Please select payment option`]' :
         '[`Please select shipping option`]') + '</em>').insertAfter(f.find('input:submit:last'));
         }
         return false;
         } else {
         f.find('em.errormsg').remove();
         }
         }
         if (f.hasClass('last') || ($("#login-form").length && !$("#login-form input:submit").attr('disabled'))) {
         return true;
         }
         $('<span class="loading"> <i class="icon16 loading"></i></span>').insertAfter(f.find('input:submit:last').attr('disabled', 'disabled'));
         $.post(f.attr('action') || window.location, f.serialize(), function(response) {
         var content = $(response);
         var step_id = content.data('step-id');
         var current = $(".checkout-step .checkout-step-content:visible");
         var current_step_id = current.find(".checkout-content").data('step-id');
         if (current_step_id != step_id) {
         current.animate({
         height: 0
         }, 200, function() {
         $(this).hide();
         });
         $(".checkout-step.step-" + step_id + " .checkout-step-content").css({
         height: 'auto'
         }).show(200, function() {
         $(document).scrollTop($(".checkout-step.step-" + step_id).offset().top);
         });
         current.parent().find('a.back').hide();
         }
         $(".checkout-step.step-" + step_id + " .checkout-content").replaceWith(content);
         $(".checkout-step.step-" + step_id + " a.back").show();
         $(".checkout-step.step-" + step_id + " input[type=submit]:last").show();
         if (current_step_id != step_id) {
         $(".checkout-step.step-" + step_id + " .checkout-step-content").show(0).css({
         height: 'auto'
         });
         }
         $(".checkout-step.step-" + step_id + ' h2').removeClass('upcoming')
         $(".checkout-step.step-" + step_id).next('.checkout-step').each(function() {
         $(this).find('h2').addClass('upcoming');
         });
         $(".checkout-step.step-" + step_id).prev('.checkout-step').each(function() {
         $(this).find('h2').removeClass('upcoming');
         });
         }).always(function() {
         f.find('span.loading').remove();
         f.find('input:submit:last').removeAttr('disabled');
         });
         return false;
         });*/
    });
</script>